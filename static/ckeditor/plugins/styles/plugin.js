/*
Copyright (c) 2003-2009, CKSource - Frederico Knabben. All rights reserved.
For licensing, see LICENSE.html or http://ckeditor.com/license
*/

CKEDITOR.plugins.add('styles',{requires:['selection']});CKEDITOR.editor.prototype.attachStyleStateChange=function(a,b){var c=this._.styleStateChangeCallbacks;if(!c){c=this._.styleStateChangeCallbacks=[];this.on('selectionChange',function(d){for(var e=0;e<c.length;e++){var f=c[e],g=f.style.checkActive(d.data.path)?CKEDITOR.TRISTATE_ON:CKEDITOR.TRISTATE_OFF;if(f.state!==g){f.fn.call(this,g);f.state!==g;}}});}c.push({style:a,fn:b});};CKEDITOR.STYLE_BLOCK=1;CKEDITOR.STYLE_INLINE=2;CKEDITOR.STYLE_OBJECT=3;(function(){var a={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},b={a:1,embed:1,hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,ul:1},c=/\s*(?:;\s*|$)/;CKEDITOR.style=function(u,v){if(v){u=CKEDITOR.tools.clone(u);o(u.attributes,v);o(u.styles,v);}var w=this.element=(u.element||'*').toLowerCase();this.type=w=='#'||a[w]?CKEDITOR.STYLE_BLOCK:b[w]?CKEDITOR.STYLE_OBJECT:CKEDITOR.STYLE_INLINE;this._={definition:u};};CKEDITOR.style.prototype={apply:function(u){t.call(this,u,false);},remove:function(u){t.call(this,u,true);},applyToRange:function(u){var v=this;return(v.applyToRange=v.type==CKEDITOR.STYLE_INLINE?d:v.type==CKEDITOR.STYLE_BLOCK?f:null).call(v,u);},removeFromRange:function(u){return(this.removeFromRange=this.type==CKEDITOR.STYLE_INLINE?e:null).call(this,u);},applyToObject:function(u){m(u,this);},checkActive:function(u){switch(this.type){case CKEDITOR.STYLE_BLOCK:return this.checkElementRemovable(u.block||u.blockLimit,true);case CKEDITOR.STYLE_INLINE:var v=u.elements;for(var w=0,x;w<v.length;w++){x=v[w];if(x==u.block||x==u.blockLimit)continue;if(this.checkElementRemovable(x,true))return true;}}return false;},checkElementRemovable:function(u,v){if(!u||u.getName()!=this.element)return false;var w=this._.definition,x;if(!v&&!u.hasAttributes())return true;x=q(w);if(x._length)for(var y in x){if(y=='_length')continue;if(s(y,x[y],u.getAttribute(y)))if(!v)return true;else if(v)return false;}return true;}};CKEDITOR.style.getStyleText=function(u){var v=u._ST;if(v)return v;v=u.styles;var w=u.attributes&&u.attributes.style||'';if(w.length)w=w.replace(c,';');for(var x in v)w+=x+':'+v[x]+';';if(w.length){w=r(w);if(w.length)w=w.replace(c,';');}return u._ST=w;};function d(u){var R=this;var v=u.document;if(u.collapsed){var w=l(R,v);u.insertNode(w);u.moveToPosition(w,CKEDITOR.POSITION_BEFORE_END);return;}var x=R.element,y=R._.definition,z,A=CKEDITOR.dtd[x]||(z=true,CKEDITOR.dtd.span),B=u.createBookmark();u.enlarge(CKEDITOR.ENLARGE_ELEMENT);u.trim();var C=u.startContainer.getChild(u.startOffset)||u.startContainer.getNextSourceNode(),D=u.endContainer.getChild(u.endOffset)||(u.endOffset?u.endContainer.getNextSourceNode():u.endContainer);
if(D.equals(C)){D=D.getNextSourceNode(true);if(!D){D=v.createText('');D.insertAfter(C);}}var E=C,F,G;while(E){var H=false;if(E.equals(D)){E=null;H=true;}else{var I=E.type,J=I==CKEDITOR.NODE_ELEMENT?E.getName():null;if(J&&E.getAttribute('_fck_bookmark')){E=E.getNextSourceNode(true);continue;}if(!J||A[J]&&(E.getPosition(D)|CKEDITOR.POSITION_PRECEDING|CKEDITOR.POSITION_IDENTICAL|CKEDITOR.POSITION_IS_CONTAINED)==(CKEDITOR.POSITION_PRECEDING+CKEDITOR.POSITION_IDENTICAL+CKEDITOR.POSITION_IS_CONTAINED)){var K=E.getParent();if(K&&((K.getDtd()||CKEDITOR.dtd.span)[x]||z)){if(!F&&(!J||!CKEDITOR.dtd.$removeEmpty[J]||(E.getPosition(D)|CKEDITOR.POSITION_PRECEDING|CKEDITOR.POSITION_IDENTICAL|CKEDITOR.POSITION_IS_CONTAINED)==(CKEDITOR.POSITION_PRECEDING+CKEDITOR.POSITION_IDENTICAL+CKEDITOR.POSITION_IS_CONTAINED))){F=new CKEDITOR.dom.range(v);F.setStartBefore(E);}if(I==CKEDITOR.NODE_TEXT||I==CKEDITOR.NODE_ELEMENT&&!E.getChildCount()&&E.$.offsetWidth){var L=E,M;while(!L.$.nextSibling&&(M=L.getParent(),A[M.getName()])&&((M.getPosition(C)|CKEDITOR.POSITION_FOLLOWING|CKEDITOR.POSITION_IDENTICAL|CKEDITOR.POSITION_IS_CONTAINED)==(CKEDITOR.POSITION_FOLLOWING+CKEDITOR.POSITION_IDENTICAL+CKEDITOR.POSITION_IS_CONTAINED)))L=M;F.setEndAfter(L);if(!L.$.nextSibling)H=true;if(!G)G=I!=CKEDITOR.NODE_TEXT||/[^\s\ufeff]/.test(E.getText());}}else H=true;}else H=true;E=E.getNextSourceNode();}if(H&&G&&F&&!F.collapsed){var N=l(R,v),O=F.getCommonAncestor();while(N&&O){if(O.getName()==x){for(var P in y.attribs)if(N.getAttribute(P)==O.getAttribute(P))N.removeAttribute(P);for(var Q in y.styles)if(N.getStyle(Q)==O.getStyle(Q))N.removeStyle(Q);if(!N.hasAttributes()){N=null;break;}}O=O.getParent();}if(N){F.extractContents().appendTo(N);h(R,N);F.insertNode(N);j(N);if(!CKEDITOR.env.ie)N.$.normalize();}F=null;}}u.moveToBookmark(B);};function e(u){u.enlarge(CKEDITOR.ENLARGE_ELEMENT);var v=u.createBookmark(true),w=u.document.getById(v.startNode);if(u.collapsed){var x=new CKEDITOR.dom.elementPath(w.getParent());for(var y=0,z;y<x.elements.length&&(z=x.elements[y]);y++){if(z==x.block||z==x.blockLimit)break;if(this.checkElementRemovable(z)){j(z);g(this,z);}}}else{var A=u.document.getById(v.endNode),B=this;function C(){var F=new CKEDITOR.dom.elementPath(w.getParent()),G=new CKEDITOR.dom.elementPath(A.getParent()),H=null,I=null;for(var J=0;J<F.elements.length;J++){var K=F.elements[J];if(K==F.block||K==F.blockLimit)break;if(B.checkElementRemovable(K))H=K;}for(var J=0;J<G.elements.length;J++){var K=G.elements[J];if(K==G.block||K==G.blockLimit)break;
if(B.checkElementRemovable(K))I=K;}if(I)A.breakParent(I);if(H)w.breakParent(H);};C();var D=w.getNext();while(!D.equals(A)){var E=D.getNextSourceNode();if(D.type==CKEDITOR.NODE_ELEMENT&&this.checkElementRemovable(D)){g(this,D);if(E.type==CKEDITOR.NODE_ELEMENT&&E.contains(w)){C();E=w.getNext();}}D=E;}}u.moveToBookmark(v);};function f(u){var v=u.createBookmark(),w=u.createIterator();w.enforceRealBlocks=true;var x,y=u.document,z;while(x=w.getNextParagraph()){var A=l(this,y);x.moveChildren(A);A.insertBefore(x);x.remove();}u.moveToBookmark(v);};function g(u,v){var w=u._.definition,x=w.attributes,y=w.styles;for(var z in x){if(z=='class'&&v.getAttribute(z)!=x[z])continue;v.removeAttribute(z);}for(var A in y)v.removeStyle(A);i(v);};function h(u,v){var w=u._.definition,x=w.attributes,y=w.styles,z=v.getElementsByTag(u.element);for(var A=z.count();--A>=0;)g(u,z.getItem(A));};function i(u){if(!u.hasAttributes()){var v=u.getFirst(),w=u.getLast();u.remove(true);if(v){j(v);if(w&&!v.equals(w))j(w);}}};function j(u){if(!u||u.type!=CKEDITOR.NODE_ELEMENT||!CKEDITOR.dtd.$removeEmpty[u.getName()])return;k(u,u.getNext(),true);k(u,u.getPrevious());};function k(u,v,w){if(v&&v.type==CKEDITOR.NODE_ELEMENT){var x=v.getAttribute('_fck_bookmark');if(x)v=w?v.getNext():v.getPrevious();if(v&&v.type==CKEDITOR.NODE_ELEMENT&&u.isIdentical(v)){var y=w?u.getLast():u.getFirst();if(x)(w?v.getPrevious():v.getNext()).move(u,!w);v.moveChildren(u,!w);v.remove();if(y)j(y);}}};function l(u,v){var w,x=u._.definition,y=u.element;if(y=='*')y='span';w=new CKEDITOR.dom.element(y,v);return m(w,u);};function m(u,v){var w=v._.definition,x=w.attributes,y=CKEDITOR.style.getStyleText(w);if(x)for(var z in x)u.setAttribute(z,x[z]);if(y)u.setAttribute('style',y);return u;};var n=/#\((.+?)\)/g;function o(u,v){for(var w in u)u[w]=u[w].replace(n,function(x,y){return v[y];});};var p=/\s+/g;function q(u){var v=u._AC;if(v)return v;v={};var w=0,x=u.attributes;if(x)for(var y in x){w++;v[y.toLowerCase()]=x[y].toLowerCase();}var z=CKEDITOR.style.getStyleText(u);if(z.length>0){if(!v.style)w++;v.style=z.replace(p,'').toLowerCase();}v._length=w;return u._AC=v;};function r(u){var v=document.createElement('span');v.style.cssText=u;return v.style.cssText;};function s(u,v,w){if(v==w||!v&&!w)return true;else if(!v||!w)return false;w=w.toLowerCase();if(u=='style'){w=w.replace(p,'');if(w.charAt(w.length-1)!=';')w+=';';}return v==w;};function t(u,v){var w=u.getSelection(),x=w.getRanges(),y=v?this.removeFromRange:this.applyToRange;for(var z=0;
z<x.length;z++)y.call(this,x[z]);w.selectRanges(x);};})();CKEDITOR.styleCommand=function(a){this.style=a;};CKEDITOR.styleCommand.prototype.exec=function(a){var c=this;a.focus();var b=a.document;if(b)if(c.state==CKEDITOR.TRISTATE_OFF)c.style.apply(b);else if(c.state==CKEDITOR.TRISTATE_ON)c.style.remove(b);return!!b;};
