/*
Copyright (c) 2003-2009, CKSource - Frederico Knabben. All rights reserved.
For licensing, see LICENSE.html or http://ckeditor.com/license
*/

(function(){var a=function(){var k=this;var h=k.getSelection();if(!h)return;var i=h.getStartElement(),j=new CKEDITOR.dom.elementPath(i);if(!j.compare(k._.selectionPreviousPath)){k._.selectionPreviousPath=j;k.fire('selectionChange',{selection:h,path:j,element:i});}},b,c,d=function(){c=true;if(b)return;e.call(this);b=CKEDITOR.tools.setTimeout(e,200,this);},e=function(){b=null;if(c){CKEDITOR.tools.setTimeout(a,0,this);c=false;}},f={exec:function(h){switch(h.mode){case 'wysiwyg':h.document.$.execCommand('SelectAll',false,null);break;case 'source':}}};CKEDITOR.plugins.add('selection',{init:function(h){h.on('contentDom',function(){if(CKEDITOR.env.ie)h.document.on('selectionchange',d,h);else{h.document.on('mouseup',d,h);h.document.on('keyup',d,h);}});h.addCommand('selectAll',f);h.ui.addButton('SelectAll',{label:h.lang.selectAll,command:'selectAll'});h.selectionChange=d;}});CKEDITOR.editor.prototype.getSelection=function(){var j=this;var h=j.document?j.document.getSelection():null;if(h&&CKEDITOR.env.ie){var i=h.getNative().createRange();if(!i)return null;else if(i.item)return i.item(0).ownerDocument==j.document.$?h:null;else return i.parentElement().ownerDocument==j.document.$?h:null;}return h;};CKEDITOR.editor.prototype.forceNextSelectionCheck=function(){delete this._.selectionPreviousPath;};CKEDITOR.dom.document.prototype.getSelection=function(){return new CKEDITOR.dom.selection(this);};CKEDITOR.SELECTION_NONE=1;CKEDITOR.SELECTION_TEXT=2;CKEDITOR.SELECTION_ELEMENT=3;CKEDITOR.dom.selection=function(h){this.document=h;this._={cache:{}};};var g={img:1,hr:1,li:1,table:1,tr:1,td:1,embed:1,object:1,ol:1,ul:1};CKEDITOR.dom.selection.prototype={getNative:CKEDITOR.env.ie?function(){return this._.cache.nativeSel||(this._.cache.nativeSel=this.document.$.selection);}:function(){return this._.cache.nativeSel||(this._.cache.nativeSel=this.document.getWindow().$.getSelection());},getType:CKEDITOR.env.ie?function(){var k=this;if(k._.cache.type)return k._.cache.type;var h=CKEDITOR.SELECTION_NONE;try{var i=k.getNative(),j=i.type;if(j=='Text')h=CKEDITOR.SELECTION_TEXT;if(j=='Control')h=CKEDITOR.SELECTION_ELEMENT;if(i.createRange().parentElement)h=CKEDITOR.SELECTION_TEXT;}catch(l){}return k._.cache.type=h;}:function(){var l=this;if(l._.cache.type)return l._.cache.type;var h=CKEDITOR.SELECTION_TEXT,i=l.getNative();if(!i)h=CKEDITOR.SELECTION_NONE;else if(i.rangeCount==1){var j=i.getRangeAt(0),k=j.startContainer;if(k==j.endContainer&&k.nodeType==1&&j.endOffset-j.startOffset==1&&g[k.childNodes[j.startOffset].nodeName.toLowerCase()])h=CKEDITOR.SELECTION_ELEMENT;
}return l._.cache.type=h;},getRanges:CKEDITOR.env.ie?(function(){var h=function(i,j){i=i.duplicate();i.collapse(j);var k=i.parentElement(),l=k.childNodes,m;for(var n=0;n<l.length;n++){var o=l[n];if(o.nodeType==1){m=i.duplicate();m.moveToElementText(o);m.collapse();var p=m.compareEndPoints('StartToStart',i);if(p>0)break;else if(p===0)return{container:k,offset:n};m=null;}}if(!m){m=i.duplicate();m.moveToElementText(k);m.collapse(false);}m.setEndPoint('StartToStart',i);var q=m.text.length;while(q>0)q-=l[--n].nodeValue.length;if(q===0)return{container:k,offset:n};else return{container:l[n],offset:-q};};return function(){var s=this;if(s._.cache.ranges)return s._.cache.ranges;var i=s.getNative(),j=i.createRange(),k=s.getType(),l;if(k==CKEDITOR.SELECTION_TEXT){l=new CKEDITOR.dom.range(s.document);var m=h(j,true);l.setStart(new CKEDITOR.dom.node(m.container),m.offset);m=h(j);l.setEnd(new CKEDITOR.dom.node(m.container),m.offset);return s._.cache.ranges=[l];}else if(k==CKEDITOR.SELECTION_ELEMENT){var n=s._.cache.ranges=[];for(var o=0;o<j.length;o++){var p=j.item(o),q=p.parentNode,r=0;l=new CKEDITOR.dom.range(s.document);for(;r<q.childNodes.length&&q.childNodes[r]!=p;r++){}l.setStart(new CKEDITOR.dom.node(q),r);l.setEnd(new CKEDITOR.dom.node(q),r+1);n.push(l);}return n;}return s._.cache.ranges=[];};})():function(){var m=this;if(m._.cache.ranges)return m._.cache.ranges;var h=[],i=m.getNative();for(var j=0;j<i.rangeCount;j++){var k=i.getRangeAt(j),l=new CKEDITOR.dom.range(m.document);l.setStart(new CKEDITOR.dom.node(k.startContainer),k.startOffset);l.setEnd(new CKEDITOR.dom.node(k.endContainer),k.endOffset);h.push(l);}return m._.cache.ranges=h;},getStartElement:function(){var l=this;var h,i=l.getNative();switch(l.getType()){case CKEDITOR.SELECTION_ELEMENT:return l.getSelectedElement();case CKEDITOR.SELECTION_TEXT:var j=l.getRanges()[0];if(j)if(!j.collapsed){j.optimize();h=j.startContainer;if(h.type!=CKEDITOR.NODE_ELEMENT)return h.getParent();h=h.getChild(j.startOffset);if(!h||h.type!=CKEDITOR.NODE_ELEMENT)return j.startContainer;var k=h.getFirst();while(k&&k.type==CKEDITOR.NODE_ELEMENT){h=k;k=k.getFirst();}return h;}if(CKEDITOR.env.ie){j=i.createRange();j.collapse(true);h=j.parentElement();}else{h=i.anchorNode;if(h.nodeType!=1)h=h.parentNode;}}return h?new CKEDITOR.dom.element(h):null;},getSelectedElement:function(){var h;if(this.getType()==CKEDITOR.SELECTION_ELEMENT){var i=this.getNative();if(CKEDITOR.env.ie)try{h=i.createRange().item(0);}catch(k){}else{var j=i.getRangeAt(0);
h=j.startContainer.childNodes[j.startOffset];}}return h?new CKEDITOR.dom.element(h):null;},reset:function(){this._.cache={};},selectElement:CKEDITOR.env.ie?function(h){this.getNative().empty();var i;try{i=this.document.$.body.createControlRange();i.addElement(h.$);}catch(j){i=this.document.$.body.createTextRange();i.moveToElementText(h.$);}i.select();}:function(h){var i=this.document.$.createRange();i.selectNode(h.$);var j=this.getNative();j.removeAllRanges();j.addRange(i);},selectRanges:CKEDITOR.env.ie?function(h){if(h[0])h[0].select();}:function(h){var i=this.getNative();i.removeAllRanges();for(var j=0;j<h.length;j++){var k=h[j],l=this.document.$.createRange();l.setStart(k.startContainer.$,k.startOffset);l.setEnd(k.endContainer.$,k.endOffset);i.addRange(l);}},createBookmarks:function(h){var i=[],j=this.getRanges();for(var k=0;k<j.length;k++)i.push(j[k].createBookmark(h));return i;},createBookmarks2:function(h){var i=[],j=this.getRanges();for(var k=0;k<j.length;k++)i.push(j[k].createBookmark2(h));return i;},selectBookmarks:function(h){var i=[];for(var j=0;j<h.length;j++){var k=new CKEDITOR.dom.range(this.document);k.moveToBookmark(h[j]);i.push(k);}this.selectRanges(i);return this;}};})();CKEDITOR.dom.range.prototype.select=CKEDITOR.env.ie?function(){var i=this;var a=i.collapsed,b,c,d=i.createBookmark(),e=d.startNode,f;if(!a)f=d.endNode;var g=i.document.$.body.createTextRange();g.moveToElementText(e.$);g.moveStart('character',1);if(f){var h=i.document.$.body.createTextRange();h.moveToElementText(f.$);g.setEndPoint('EndToEnd',h);g.moveEnd('character',-1);}else{c=i.document.createElement('span');c.setHtml('&#65279;');c.insertBefore(e);i.document.createText('﻿').insertBefore(e);}i.setStartBefore(e);e.remove();if(a){g.moveStart('character',-1);g.select();i.document.$.selection.clear();c.remove();}else{i.setEndBefore(f);f.remove();g.select();}}:function(){var d=this;var a=d.startContainer;if(d.collapsed&&a.type==CKEDITOR.NODE_ELEMENT&&!a.getChildCount())a.append(new CKEDITOR.dom.text(''));var b=d.document.$.createRange();b.setStart(a.$,d.startOffset);try{b.setEnd(d.endContainer.$,d.endOffset);}catch(e){if(e.toString().indexOf('NS_ERROR_ILLEGAL_VALUE')>=0){d.collapse(true);b.setEnd(d.endContainer.$,d.endOffset);}else throw e;}var c=d.document.getSelection().getNative();c.removeAllRanges();c.addRange(b);};
