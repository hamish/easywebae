/*
Copyright (c) 2003-2009, CKSource - Frederico Knabben. All rights reserved.
For licensing, see LICENSE.html or http://ckeditor.com/license
*/

(function(){CKEDITOR.plugins.add('undo',{requires:['selection','wysiwygarea'],init:function(c){var d=new b(c),e=c.addCommand('undo',{exec:function(){if(d.undo()){c.selectionChange();this.fire('afterUndo');}},state:CKEDITOR.TRISTATE_DISABLED,canUndo:false}),f=c.addCommand('redo',{exec:function(){if(d.redo()){c.selectionChange();this.fire('afterRedo');}},state:CKEDITOR.TRISTATE_DISABLED,canUndo:false});d.onChange=function(){e.setState(d.undoable()?CKEDITOR.TRISTATE_OFF:CKEDITOR.TRISTATE_DISABLED);f.setState(d.redoable()?CKEDITOR.TRISTATE_OFF:CKEDITOR.TRISTATE_DISABLED);};function g(h){if(d.enabled&&h.data.command.canUndo!==false)d.save();};c.on('beforeCommandExec',g);c.on('afterCommandExec',g);c.on('mode',function(){if(c.mode=='wysiwyg')if(!d.enabled){d.enabled=true;c.document.on('keydown',function(h){if(!h.data.$.ctrlKey&&!h.data.$.metaKey)d.type();});if(d.index==-1)d.save();}else d.enabled=false;d.onChange();});c.ui.addButton('Undo',{label:c.lang.undo,command:'undo'});c.ui.addButton('Redo',{label:c.lang.redo,command:'redo'});}});function a(c){var e=this;var d=c.getSelection();e.contents=c.getSnapshot();e.bookmarks=d&&d.createBookmarks2(true);if(CKEDITOR.env.ie)e.contents=e.contents.replace(/\s+_cke_expando=".*?"/g,'');};a.prototype={equals:function(c,d){if(this.contents!=c.contents)return false;if(d)return true;var e=this.bookmarks,f=c.bookmarks;if(e||f){if(!e||!f||e.length!=f.length)return false;for(var g=0;g<e.length;g++){var h=e[g],i=f[g];if(h.startOffset!=i.startOffset||h.endOffset!=i.endOffset||!CKEDITOR.tools.arrayCompare(h.start,i.start)||!CKEDITOR.tools.arrayCompare(h.end,i.end))return false;}}return true;}};function b(c){var d=this;d.typesCount=0;d.editor=c;d.snapshots=[];d.index=-1;d.limit=c.config.undoStackSize;};b.prototype={type:function(){if(!this.typing){var c=new a(this.editor);CKEDITOR.tools.setTimeout(function(){var e=this;var d=e.editor.getSnapshot();if(CKEDITOR.env.ie)d=d.replace(/\s+_cke_expando=".*?"/g,'');if(c.contents!=d){if(!e.save(false,c))e.snapshots.splice(e.index+1,e.snapshots.length-e.index-1);e.hasUndo=true;e.hasRedo=false;e.typesCount=1;e.typing=true;e.onChange();}},0,this);return;}this.typesCount++;if(this.typesCount>25){this.save();this.typesCount=1;}this.typing=true;},fireChange:function(){var c=this;c.hasUndo=!!c.getNextImage(true);c.hasRedo=!!c.getNextImage(false);c.typing=false;c.typesCount=0;c.onChange();},save:function(c,d){var f=this;var e=f.snapshots;if(!d)d=new a(f.editor);if(f.currentImage&&d.equals(f.currentImage,c))return false;
e.splice(f.index+1,e.length-f.index-1);if(e.length==f.limit)e.shift();f.index=e.push(d)-1;f.currentImage=d;f.fireChange();return true;},restoreImage:function(c){var d=this;d.editor.loadSnapshot(c.contents);if(c.bookmarks)d.editor.getSelection().selectBookmarks(c.bookmarks);d.index=c.index;d.currentImage=c;d.fireChange();},getNextImage:function(c){var h=this;var d=h.snapshots,e=h.currentImage,f,g;if(e)if(c)for(g=h.index-1;g>=0;g--){f=d[g];if(!e.equals(f,true)){f.index=g;return f;}}else for(g=h.index+1;g<d.length;g++){f=d[g];if(!e.equals(f,true)){f.index=g;return f;}}return null;},redoable:function(){return this.enabled&&this.hasRedo;},undoable:function(){return this.enabled&&this.hasUndo;},undo:function(){var d=this;if(d.undoable()){d.save(true);var c=d.getNextImage(true);if(c)return d.restoreImage(c),true;}return false;},redo:function(){var d=this;if(d.redoable()){d.save(true);if(d.redoable()){var c=d.getNextImage(false);if(c)return d.restoreImage(c),true;}}return false;}};})();CKEDITOR.config.undoStackSize=20;
